<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Claude Meter Setup</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a1e;
      color: #e0e0e0;
      padding: 24px;
    }
    h1 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .subtitle {
      font-size: 13px;
      color: #888;
      margin-bottom: 24px;
    }
    .field {
      margin-bottom: 20px;
    }
    label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #aaa;
      margin-bottom: 6px;
    }
    input[type="text"], input[type="password"] {
      width: 100%;
      padding: 10px 12px;
      background: #2a2a2e;
      border: 1px solid #3a3a3e;
      border-radius: 6px;
      color: #e0e0e0;
      font-size: 13px;
      font-family: 'SF Mono', Monaco, monospace;
      outline: none;
    }
    input:focus {
      border-color: #4a90d9;
    }
    .hint {
      font-size: 11px;
      color: #666;
      margin-top: 4px;
      line-height: 1.5;
    }
    .steps {
      background: #222226;
      border-radius: 8px;
      padding: 14px 16px;
      margin-bottom: 24px;
      font-size: 12px;
      line-height: 1.8;
      color: #999;
    }
    .steps strong {
      color: #ccc;
    }
    .steps code {
      background: #333;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 11px;
      color: #4a90d9;
    }
    button {
      width: 100%;
      padding: 12px;
      background: #4a90d9;
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover { background: #357abd; }
    button:disabled {
      background: #3a3a3e;
      color: #666;
      cursor: default;
    }
    #status {
      margin-top: 12px;
      font-size: 12px;
      text-align: center;
      min-height: 18px;
    }
    .error { color: #ef5350; }
    .success { color: #66bb6a; }
  </style>
</head>
<body>
  <h1>Claude Meter Setup</h1>
  <p class="subtitle">Connect to your claude.ai account to monitor usage limits.</p>

  <div class="steps">
    <strong>How to get your session key:</strong><br>
    1. Open <code>claude.ai</code> in your browser (make sure you're logged in)<br>
    2. Open DevTools (<code>F12</code> or <code>Cmd+Option+I</code>)<br>
    3. Go to <strong>Application</strong> (Chrome) or <strong>Storage</strong> (Firefox) tab<br>
    4. Under <strong>Cookies</strong> &rarr; <code>https://claude.ai</code><br>
    5. Copy the value of <code>sessionKey</code><br>
    6. Also copy the value of <code>lastActiveOrg</code> for the Org ID
  </div>

  <div class="field">
    <label for="session-key">Session Key</label>
    <input type="password" id="session-key" placeholder="sk-ant-sid02-..." />
    <p class="hint">Starts with <code>sk-ant-sid02-</code>. Stored locally, never sent anywhere except claude.ai.</p>
  </div>

  <div class="field">
    <label for="org-id">Organization ID</label>
    <input type="text" id="org-id" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" />
    <p class="hint">UUID from <code>lastActiveOrg</code> cookie. Usually your personal org.</p>
  </div>

  <button id="save-btn" onclick="save()">Save &amp; Connect</button>
  <div id="status"></div>

  <script>
    const { invoke } = window.__TAURI__.core;

    async function loadExisting() {
      try {
        const config = await invoke('get_config');
        if (config.session_key) {
          document.getElementById('session-key').value = config.session_key;
        }
        if (config.org_id) {
          document.getElementById('org-id').value = config.org_id;
        }
      } catch (e) {
        // ignore
      }
    }

    async function save() {
      const sessionKey = document.getElementById('session-key').value.trim();
      const orgId = document.getElementById('org-id').value.trim();
      const status = document.getElementById('status');
      const btn = document.getElementById('save-btn');

      if (!sessionKey || !orgId) {
        status.className = 'error';
        status.textContent = 'Both fields are required.';
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Connecting...';
      status.className = '';
      status.textContent = '';

      try {
        const result = await invoke('save_config', {
          sessionKey: sessionKey,
          orgId: orgId,
        });
        status.className = 'success';
        status.textContent = 'Connected! This window will close shortly.';
        setTimeout(() => window.close(), 1500);
      } catch (e) {
        status.className = 'error';
        status.textContent = `Error: ${e}`;
        btn.disabled = false;
        btn.textContent = 'Save & Connect';
      }
    }

    loadExisting();
  </script>
</body>
</html>
